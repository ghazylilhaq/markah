## Codebase Patterns
- Prisma v6 used (not v7). DB connects to local PostgreSQL with user pomo/pomo. Prisma v6 warns about `package.json#prisma` config being deprecated in v7.
- Seed script uses `npx tsx prisma/seed.ts` — tsx is auto-installed by npx.
- NextAuth.js v5 (beta.30) with JWT strategy and credentials provider — no Prisma adapter (custom User model).
- Auth config lives in `lib/auth.ts`, exports `{ handlers, signIn, signOut, auth }`.
- Session helper functions in `lib/session.ts` — use `getCurrentUser()` or `requireUser()` for auth checks.
- Server actions go in `lib/actions/` directory.
- Type augmentations for next-auth in `types/next-auth.d.ts`.
- Path alias: `@/*` maps to project root.
- shadcn/ui with "new-york" style, stone base color, lucide icons.
- Tailwind CSS v4 with PostCSS plugin.
- Auth pages use `(auth)` route group with centered layout in `app/(auth)/layout.tsx`.
- `next lint` command doesn't work (Next.js 16 changed CLI); use `npx eslint` directly instead.
- Auth middleware at `middleware.ts` uses `auth()` from `lib/auth.ts` — public routes: `/`, `/login`, `/register`, `/share/*`.
- Services go in `lib/services/` directory — use `"use server"` directive for server-side-only code.
- Dashboard layout uses server component (`app/dashboard/layout.tsx`) to fetch data, passes to client `DashboardShell` component.
- Sidebar is a client component (`components/sidebar.tsx`) that reads `?folder=` query param for active state.
- Mobile sidebar uses shadcn/ui Sheet component (left side) with hamburger menu trigger.
- Folder tree built from flat Prisma query via `buildFolderTree()` helper in dashboard layout.
- Sonner (toast) installed as shadcn/ui component; Toaster added to root `app/layout.tsx`. Use `toast()` from `sonner` package.
- Bookmark server actions in `lib/actions/bookmark.ts` — use `requireUser()` for auth.
- BookmarkCard data type (`BookmarkCardData`) exported from `components/bookmark-card.tsx` — used by both card and list item views.
- Deterministic color helpers (`hashCode`, `domainToColor`, `tagToColor`) defined locally in bookmark-card.tsx and bookmark-list-item.tsx.
- Optimistic update pattern for favorite toggle: setState immediately → call server action → revert on error → router.refresh().
---

## 2026-02-17 - US-002
- What was implemented: NextAuth.js v5 credentials authentication setup
- Files changed:
  - `lib/auth.ts` — NextAuth config with credentials provider, JWT callbacks
  - `lib/session.ts` — getCurrentUser() and requireUser() helper functions
  - `lib/actions/auth.ts` — registerUser() server action with bcrypt hashing
  - `app/api/auth/[...nextauth]/route.ts` — API route handler
  - `types/next-auth.d.ts` — Session type augmentation to include user.id
  - `package.json` — Added next-auth, bcryptjs, @types/bcryptjs
  - `.env` — Added NEXTAUTH_SECRET
- **Learnings for future iterations:**
  - NextAuth v5 doesn't need Prisma adapter when using custom User model without Account/Session tables
  - Credentials provider uses JWT strategy (not database sessions)
  - The `authorize` callback in credentials provider must return `null` for invalid credentials (not throw)
  - Session callback chain: user → jwt callback (adds id to token) → session callback (adds id to session.user)
---

## 2026-02-17 - US-003
- What was implemented: Registration page UI at /register
- Files changed:
  - `app/(auth)/layout.tsx` — Shared auth layout with centered card design
  - `app/(auth)/register/page.tsx` — Registration form with email/password, validation, error handling
  - `components/ui/button.tsx` — shadcn/ui Button component
  - `components/ui/input.tsx` — shadcn/ui Input component
  - `components/ui/label.tsx` — shadcn/ui Label component
  - `components/ui/card.tsx` — shadcn/ui Card component
- **Learnings for future iterations:**
  - shadcn/ui components installed via `npx shadcn@latest add <component> --yes`
  - Auth pages use (auth) route group for shared centered layout
  - `next lint` doesn't work in Next.js 16; use `npx eslint` directly
  - Registration uses existing `registerUser` server action from `lib/actions/auth.ts`
---

## 2026-02-17 - US-004
- What was implemented: Login page UI at /login
- Files changed:
  - `app/(auth)/login/page.tsx` — Login form with email/password, NextAuth signIn, error handling
- **Learnings for future iterations:**
  - Use `signIn("credentials", { ..., redirect: false })` from `next-auth/react` for client-side login with error handling
  - `signIn` returns `{ error: string | undefined }` — check `result?.error` to show error messages
  - Login page reuses same (auth) layout and shadcn/ui Card pattern as registration
  - `autoComplete="current-password"` for login vs `autoComplete="new-password"` for registration
---

## 2026-02-17 - US-005
- What was implemented: Auth middleware and protected routes
- Files changed:
  - `middleware.ts` — NextAuth v5 auth() middleware with route protection logic
- **Learnings for future iterations:**
  - NextAuth v5 exports `auth` from config that can wrap middleware: `export default auth((req) => { ... })`
  - `req.auth` is the session object in the middleware callback — truthy when logged in
  - Matcher `["/((?!api|_next/static|_next/image|favicon.ico).*)"]` excludes API routes and static assets
  - Public routes: `/`, `/login`, `/register`, `/share/*`
  - Auth routes (`/login`, `/register`) redirect to `/dashboard` when already authenticated
---

## 2026-02-17 - US-006
- What was implemented: Landing page at / with hero section, features grid, and placeholder illustration area
- Files changed:
  - `app/page.tsx` — Complete rewrite: hero section with app name, description, Get Started CTA, Sign In link, placeholder illustration, 6 feature cards, footer
  - `app/layout.tsx` — Updated metadata title and description for Markah
- **Learnings for future iterations:**
  - Landing page uses lucide-react icons (Bookmark, FolderOpen, Search, Share2, Sparkles, Tag) — already available in project
  - stone color palette consistent with auth pages (bg-stone-50, text-stone-900, etc.)
  - FeatureCard is a local component in page.tsx — no need for separate file for single-use components
---

## 2026-02-17 - US-007
- What was implemented: Prisma seed script with test data
- Files changed:
  - `prisma/seed.ts` — Seed script creating test user, 12 bookmarks, 8 tags, 3 folders with associations
  - `package.json` — Added `prisma.seed` config pointing to `npx tsx prisma/seed.ts`
- **Learnings for future iterations:**
  - Seed idempotency: upsert for user, then delete-recreate for all child data (tags, folders, bookmarks, associations)
  - `prisma.seed` in package.json is deprecated in Prisma v7 — will need prisma.config.ts migration eventually
  - tsx is not a project dependency but npx auto-installs it; consider adding to devDependencies if seed runs in CI
  - Test user credentials: test@markah.com / password123
---

## 2026-02-17 - US-008
- What was implemented: Link preview fetching service at lib/services/link-preview.ts
- Files changed:
  - `lib/services/link-preview.ts` — Server-side service that fetches a URL and extracts OG/meta tag data (title, description, image, favicon)
- **Learnings for future iterations:**
  - No external HTML parser needed — regex works fine for extracting meta tags from HTML head
  - `"use server"` directive used to keep the service server-side only
  - AbortController with setTimeout provides clean 10s fetch timeout
  - Meta tags can have property/name and content in either order — regex must handle both
  - Relative URLs in og:image and favicon href need resolving against the base URL
  - Graceful fallback: hostname extracted from URL used as title when fetch fails entirely
---

## 2026-02-17 - US-009
- What was implemented: Dashboard layout with fixed sidebar and responsive mobile menu
- Files changed:
  - `app/dashboard/layout.tsx` — Server component: fetches user + folders, builds folder tree, passes to DashboardShell
  - `app/dashboard/page.tsx` — Placeholder dashboard page
  - `components/dashboard-shell.tsx` — Client component: sidebar (desktop), Sheet sidebar (mobile), header with user email + logout
  - `components/sidebar.tsx` — Client component: virtual folders (All, Favorites, Unsorted) + user folder tree with nesting
  - `components/ui/sheet.tsx` — shadcn/ui Sheet component (installed)
- **Learnings for future iterations:**
  - Dashboard uses server→client component split: layout.tsx (server) fetches data, DashboardShell (client) handles interactivity
  - Sidebar active state based on `?folder=` search param, not pathname
  - Folder tree built from flat DB query using parentId→children mapping
  - Sheet component from shadcn/ui uses Radix Dialog internally; must include SheetTitle for accessibility
  - signOut from next-auth/react with `{ redirectTo: "/" }` for post-logout redirect
---

## 2026-02-17 - US-010
- What was implemented: Quick-add bookmark URL bar at top of dashboard
- Files changed:
  - `lib/actions/bookmark.ts` — Server action: addBookmark creates bookmark, checks duplicates, async metadata fetch
  - `components/quick-add-bar.tsx` — Client component: URL input with loading state, URL validation/normalization, toast on duplicate
  - `components/ui/sonner.tsx` — Sonner toast component (shadcn/ui)
  - `app/layout.tsx` — Added Toaster to root layout
  - `app/dashboard/page.tsx` — Integrated QuickAddBar component
  - `prd.json` — Marked US-010 as passes: true
- **Learnings for future iterations:**
  - Sonner toast: import `toast` from `sonner` package, `Toaster` component from `components/ui/sonner.tsx`
  - Server actions can fire-and-forget async operations (metadata fetch) by calling `.catch()` without awaiting
  - URL normalization: prepend `https://` if no protocol, validate with `new URL()` constructor
  - `router.refresh()` from `next/navigation` triggers server component re-render to show updated data
---

## 2026-02-17 - US-011
- What was implemented: BookmarkCard component (already existed from US-012 implementation)
- Files changed:
  - `components/bookmark-card.tsx` — BookmarkCard with thumbnail/color card, title, description, domain, tags, date, favorite toggle
  - `components/ui/badge.tsx` — shadcn/ui Badge component for tag display
  - `lib/actions/bookmark.ts` — toggleFavorite server action
- **Learnings for future iterations:**
  - US-011 and US-012 were implemented together since BookmarkCard was needed for the list view
  - `hashCode` function used for deterministic domain→color and tag→color mapping (HSL with different saturation/lightness)
  - `line-clamp-2` Tailwind class limits description to 2 lines
  - Optimistic UI update pattern: set state immediately, revert on error, call server action in between
  - External images use `<img>` not `next/image` since domains are unknown/dynamic
---

## 2026-02-17 - US-012
- What was implemented: Bookmark list view with grid/list toggle (already existed from previous commit)
- Files changed:
  - `components/bookmark-list-view.tsx` — Grid/list toggle, cursor-based pagination, localStorage view persistence
  - `components/bookmark-list-item.tsx` — Compact list row variant of bookmark display
  - `app/dashboard/page.tsx` — Integrated BookmarkListView with initial data from server
- **Learnings for future iterations:**
  - `useSyncExternalStore` is the React way to subscribe to external stores like localStorage
  - Dispatching a synthetic `StorageEvent` forces re-render when localStorage changes within same tab
  - Button `size="icon-sm"` custom variant added to shadcn/ui button for small icon buttons
  - Cursor-based pagination: fetch limit+1 items, if got more than limit then there's a next page
---

## 2026-02-17 - US-013
- What was implemented: Visit tracking on bookmark click (already implemented in earlier stories)
- Files already containing the implementation:
  - `lib/actions/bookmark.ts` — `recordVisit` server action (lines 97-107) increments visitCount and sets lastVisitedAt
  - `components/bookmark-card.tsx` — `handleVisit` called on click (line 110-112), visit count display (lines 277-284), relative time display (lines 285-290)
  - `components/bookmark-list-item.tsx` — `handleVisit` called on click (line 86-88), visit info display (lines 168-173)
- **Learnings for future iterations:**
  - Some stories get implemented ahead of schedule as dependencies of later stories — always check if work already exists before starting
  - `formatRelativeTime` helper provides human-readable time (just now, Xm ago, Xh ago, Xd ago, Xmo ago)
---

## 2026-02-17 - US-014
- What was implemented: Edit bookmark form (already implemented in earlier iterations)
- Files already containing the implementation:
  - `components/edit-bookmark-dialog.tsx` — Full edit dialog with title, description, tags (chips + autocomplete), folder checkboxes
  - `lib/actions/bookmark.ts` — `updateBookmark`, `getBookmarkDetails`, `getUserTags`, `getUserFolders` server actions
  - `components/bookmark-card.tsx` — Edit (Pencil) button integrated
  - `components/bookmark-list-item.tsx` — Edit (Pencil) button integrated
- **Learnings for future iterations:**
  - Tag autocomplete uses onMouseDown instead of onClick to fire before onBlur closes the dropdown
  - Folder labels built recursively with `getFolderLabel` for nested display (parent / child)
---

## 2026-02-17 - US-015
- What was implemented: Delete bookmark with confirmation (already implemented in earlier iterations)
- Files already containing the implementation:
  - `components/bookmark-card.tsx` — Trash2 icon + AlertDialog confirmation
  - `components/bookmark-list-item.tsx` — Trash2 icon + AlertDialog confirmation
  - `lib/actions/bookmark.ts` — `deleteBookmark` server action with transaction
- **Learnings for future iterations:**
  - AlertDialog from shadcn/ui wraps Radix AlertDialog — use AlertDialogTrigger asChild for custom trigger buttons
  - Transaction ensures tag/folder associations are deleted before the bookmark
---

## 2026-02-17 - US-016
- What was implemented: AI tag suggestion provider interface (already implemented in earlier iterations)
- Files already containing the implementation:
  - `lib/services/llm-provider.ts` — LLMProvider interface, ClaudeProvider, OpenAIProvider, OllamaProvider, getLLMProvider factory
  - `.env.example` — LLM_PROVIDER and LLM_API_KEY documented
- **Learnings for future iterations:**
  - parseTags validates JSON array and regex-checks each tag against `^[a-z0-9]+(-[a-z0-9]+)*$`
  - getLLMProvider returns null if provider not configured — callers must handle null gracefully
---
