## Codebase Patterns
- Database: Supabase PostgreSQL is remote — `prisma migrate dev` requires DB connection; create migrations manually in `prisma/migrations/YYYYMMDD_description/migration.sql` and apply with `npx prisma migrate deploy`
- After schema changes: always run `npx prisma generate` (no DB needed) to update the Prisma client
- TypeScript check: `npx tsc --noEmit` (no output = passes)
- Unique indexes on nullable columns: PostgreSQL allows multiple NULLs naturally; `@@unique([externalId, userId])` in schema is safe for nullable externalId
- .env* is gitignored — use `git add -f` for .env.example

# Ralph Progress Log
Started: Wed Feb 18 20:55:53 WIB 2026
---

## 2026-02-18 - US-001
- Added `XIntegration` model to `prisma/schema.prisma` with all required fields (xUserId, xHandle, accessToken, refreshToken, expiresAt, lastSyncedAt, lastSyncedTweetId, syncEnabled, retryCount, lastError)
- Added `source` (String?) and `externalId` (String?) fields to `Bookmark` model
- Added `@@unique([externalId, userId])` constraint on Bookmark
- Added `xIntegration XIntegration?` relation to User model
- Created manual migration at `prisma/migrations/20260218_add_x_integration/migration.sql`
- Ran `npx prisma generate` to update Prisma client
- Files changed: `prisma/schema.prisma`, `prisma/migrations/20260218_add_x_integration/migration.sql`
- **Learnings for future iterations:**
  - The Supabase remote DB is not reachable from local dev environment — always create migrations manually
  - Use `npx prisma generate` (no DB needed) to update the generated client after schema changes
  - `@@unique` on nullable fields works correctly in PostgreSQL (multiple NULLs are distinct)
---

## 2026-02-18 - US-003
- Created `app/api/auth/x/callback/route.ts` GET handler for X OAuth callback
- Validates PKCE cookie (HMAC-SHA256 signature verification using timingSafeEqual)
- Validates state parameter matches stored state (CSRF protection)
- Exchanges authorization code for tokens via POST to https://api.twitter.com/2/oauth2/token with Basic auth
- Fetches X user info (id, username) via GET https://api.twitter.com/2/users/me
- Upserts XIntegration record for authenticated Markah user
- Clears PKCE cookie after successful exchange (maxAge: 0)
- Redirects to /dashboard/settings?connected=true on success, /dashboard/settings?error=... on OAuth error
- Created `lib/services/x-auth.ts` with `refreshXToken(integration: XIntegration)` helper
- refreshXToken POSTs to token endpoint with grant_type=refresh_token, updates DB, returns new access token
- Files changed: `app/api/auth/x/callback/route.ts`, `lib/services/x-auth.ts`
- **Learnings for future iterations:**
  - Cookie verification: use `crypto.timingSafeEqual` to compare HMAC values (prevents timing attacks)
  - X token exchange uses Basic auth (base64 of clientId:clientSecret), same pattern as refresh
  - Cookie clearing: set maxAge: 0 (not just delete) to ensure the browser removes it
  - The XIntegration import from `@prisma/client` works directly since it's in the schema
---

## 2026-02-18 - US-002
- Created `app/api/auth/x/route.ts` with GET handler for X OAuth initiation
- Generates PKCE code_verifier (96 random bytes → base64url = 128 chars) and S256 code_challenge
- Generates random state for CSRF protection
- Signs cookie payload with HMAC-SHA256 using NEXTAUTH_SECRET to prevent tampering
- Stores signed JSON (codeVerifier + state) in HTTP-only cookie `x_oauth_pkce` (10 min TTL)
- Redirects to https://twitter.com/i/oauth2/authorize with all required params
- Returns 401 if user not authenticated via auth(), 500 if env vars missing
- Files changed: `app/api/auth/x/route.ts`
- **Learnings for future iterations:**
  - Cookie signing: use HMAC-SHA256 with NEXTAUTH_SECRET; format is `${hmac}.${base64(payload)}`
  - PKCE base64url encoding: replace +→-, /→_, strip = padding; use crypto.randomBytes(96) for 128-char verifier
  - Next.js API routes use NextResponse.redirect() and can set cookies on the response before redirecting
---
