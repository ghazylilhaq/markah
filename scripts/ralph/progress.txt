# Ralph Progress Log
Started: Fri Feb 27 14:51:12 WIB 2026
---

## Codebase Patterns
- Migrations use raw SQL in `prisma/migrations/YYYYMMDD_description/migration.sql` ‚Äî always use `IF NOT EXISTS` guards
- Run `npx prisma generate` after schema changes (not `migrate dev` in production context)
- The existing migration pattern uses `ALTER TABLE ... ADD COLUMN IF NOT EXISTS` for new columns
- radix-ui Tooltip is available via `import { Tooltip } from "radix-ui"` ‚Äî same pattern as Dialog, DropdownMenu, etc.
- When adding a field to Folder type in sidebar.tsx, update ALL callers of buildFolderTree: both app/dashboard/layout.tsx AND app/dashboard/page.tsx have their own copies
- prisma.xSyncStatus.upsert uses `where: { userId }` since userId is @unique; manually set `updatedAt: new Date()` in the update block

---

## 2026-02-27 - US-002 through US-009 (X Bookmark Folder Sync - all stories)

### US-002: fetchXBookmarkFolders()
- Added `XCollection` type and `fetchXBookmarkFolders()` to lib/services/x-bookmarks.ts
- Returns `{ folders, unavailable }` ‚Äî unavailable=true on 403/404, false on other errors
- Files: lib/services/x-bookmarks.ts

### US-003: fetchXBookmarksInFolder()
- Added `fetchXBookmarksInFolder()` with pagination (up to 500 IDs) and 3-retry exponential backoff on HTTP 429
- Returns `{ tweetIds, failed }` ‚Äî failed=true if all retries exhausted
- Files: lib/services/x-bookmarks.ts

### US-004: getOrCreateXCollectionFolder()
- Added `getOrCreateXCollectionFolder()` to lib/services/x-sync-core.ts
- Idempotent: first lookup by xCollectionId, then check for name conflict before creating
- Also updated `getOrCreateXBookmarksFolder()` to set isSyncManaged: true on existing and new folders
- Files: lib/services/x-sync-core.ts

### US-005: Collection subfolder assignment in performXSync()
- Added `partial: boolean` to SyncResult type
- performXSync now fetches collections, builds tweetId‚ÜífolderId map, assigns new bookmarks to collection subfolders
- Merge path: updates sync-managed BookmarkFolder rows without touching user-created ones
- Files: lib/services/x-sync-core.ts

### US-006: XSyncStatus persistence
- performXSync upserts XSyncStatus after sync: success/partial/error with collectionsNote flag
- Partial: errorMessage='Some collections could not be fetched due to rate limits.'
- Error: errorMessage from caught exception
- Files: lib/services/x-sync-core.ts

### US-007: X badge in sidebar
- Created components/ui/tooltip.tsx using radix-ui Tooltip primitive
- Created components/x-sync-badge.tsx with ùïè glyph and tooltip text
- Added isSyncManaged to Folder type in sidebar.tsx; renders XSyncBadge after folder name
- Updated isSyncManaged in folder select queries in layout.tsx AND page.tsx
- Files: components/ui/tooltip.tsx, components/x-sync-badge.tsx, components/sidebar.tsx, app/dashboard/layout.tsx, app/dashboard/page.tsx

### US-008: Sync status in settings
- Settings page fetches XSyncStatus alongside XIntegration
- XIntegrationControls shows amber banner on partial, blue banner when collectionsNote=true
- Last-synced timestamp prefers XSyncStatus.lastSyncedAt, falls back to XIntegration.lastSyncedAt
- Files: app/dashboard/settings/page.tsx, app/dashboard/settings/x-integration-controls.tsx

### US-009: disconnectX folder cleanup
- disconnectX now: deletes XIntegration, converts isSyncManaged folders to regular, deletes XSyncStatus
- Files: lib/actions/x-sync.ts

**Learnings:**
- `buildFolderTree` is duplicated in layout.tsx and page.tsx ‚Äî both must be updated for new Folder fields
- radix-ui exposes Tooltip (and other primitives) from the unified package, same as Dialog/DropdownMenu
- `xSyncStatus.updatedAt` must be set manually in upsert update block (Prisma @updatedAt doesn't fire on raw updates)

---

## 2026-02-27 - US-001
- Added `isSyncManaged Boolean @default(false)` and `xCollectionId String?` fields to Folder model in prisma/schema.prisma
- Created XSyncStatus model with: id (cuid), userId (@unique), lastSyncedAt, status, errorMessage, collectionsNote (@default(false)), createdAt, updatedAt
- Added `xSyncStatus XSyncStatus?` relation to User model and back-relation on XSyncStatus with onDelete: Cascade
- Created prisma/migrations/20260227_x_folder_sync/migration.sql with ALTER TABLE for Folder columns and CREATE TABLE for XSyncStatus
- Ran `npx prisma generate` ‚Äî client updated successfully
- Typecheck passed
- Files changed: prisma/schema.prisma, prisma/migrations/20260227_x_folder_sync/migration.sql
- **Learnings for future iterations:**
  - Prisma v6 schema additions work cleanly; no issues with new model or new fields
  - Migration file must include UNIQUE INDEX for one-to-one relations (XSyncStatus_userId_key) to match Prisma schema @unique annotation
  - The `updatedAt` field in raw SQL migration does NOT need a DEFAULT since Prisma handles it via @updatedAt, but we still need the column in CREATE TABLE ‚Äî set `NOT NULL` and Prisma will manage it at the ORM level
---
