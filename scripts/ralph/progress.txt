## Codebase Patterns
- Database: Supabase PostgreSQL is remote — `prisma migrate dev` requires DB connection; create migrations manually in `prisma/migrations/YYYYMMDD_description/migration.sql` and apply with `npx prisma migrate deploy`
- After schema changes: always run `npx prisma generate` (no DB needed) to update the Prisma client
- TypeScript check: `npx tsc --noEmit` (no output = passes)
- Unique indexes on nullable columns: PostgreSQL allows multiple NULLs naturally; `@@unique([externalId, userId])` in schema is safe for nullable externalId
- .env* is gitignored — use `git add -f` for .env.example

# Ralph Progress Log
Started: Wed Feb 18 20:55:53 WIB 2026
---

## 2026-02-18 - US-001
- Added `XIntegration` model to `prisma/schema.prisma` with all required fields (xUserId, xHandle, accessToken, refreshToken, expiresAt, lastSyncedAt, lastSyncedTweetId, syncEnabled, retryCount, lastError)
- Added `source` (String?) and `externalId` (String?) fields to `Bookmark` model
- Added `@@unique([externalId, userId])` constraint on Bookmark
- Added `xIntegration XIntegration?` relation to User model
- Created manual migration at `prisma/migrations/20260218_add_x_integration/migration.sql`
- Ran `npx prisma generate` to update Prisma client
- Files changed: `prisma/schema.prisma`, `prisma/migrations/20260218_add_x_integration/migration.sql`
- **Learnings for future iterations:**
  - The Supabase remote DB is not reachable from local dev environment — always create migrations manually
  - Use `npx prisma generate` (no DB needed) to update the generated client after schema changes
  - `@@unique` on nullable fields works correctly in PostgreSQL (multiple NULLs are distinct)
---

## 2026-02-18 - US-003
- Created `app/api/auth/x/callback/route.ts` GET handler for X OAuth callback
- Validates PKCE cookie (HMAC-SHA256 signature verification using timingSafeEqual)
- Validates state parameter matches stored state (CSRF protection)
- Exchanges authorization code for tokens via POST to https://api.twitter.com/2/oauth2/token with Basic auth
- Fetches X user info (id, username) via GET https://api.twitter.com/2/users/me
- Upserts XIntegration record for authenticated Markah user
- Clears PKCE cookie after successful exchange (maxAge: 0)
- Redirects to /dashboard/settings?connected=true on success, /dashboard/settings?error=... on OAuth error
- Created `lib/services/x-auth.ts` with `refreshXToken(integration: XIntegration)` helper
- refreshXToken POSTs to token endpoint with grant_type=refresh_token, updates DB, returns new access token
- Files changed: `app/api/auth/x/callback/route.ts`, `lib/services/x-auth.ts`
- **Learnings for future iterations:**
  - Cookie verification: use `crypto.timingSafeEqual` to compare HMAC values (prevents timing attacks)
  - X token exchange uses Basic auth (base64 of clientId:clientSecret), same pattern as refresh
  - Cookie clearing: set maxAge: 0 (not just delete) to ensure the browser removes it
  - The XIntegration import from `@prisma/client` works directly since it's in the schema
---

## 2026-02-18 - US-004
- Created `components/integration-card.tsx` — generic card component with props: name, icon, description, connected (boolean), children slot
- Created `app/dashboard/settings/page.tsx` as server component that fetches XIntegration record via Prisma
- Created `app/dashboard/settings/connected-toast.tsx` as client component to show success toast when `?connected=true` is in URL
- Added Settings icon link at bottom of sidebar in `components/sidebar.tsx` (below folder tree, with border separator)
- X logo rendered as inline SVG in settings page
- Middleware already handles /dashboard/settings protection (all non-public routes redirect to login)
- Files changed: `components/integration-card.tsx`, `app/dashboard/settings/page.tsx`, `app/dashboard/settings/connected-toast.tsx`, `components/sidebar.tsx`
- **Learnings for future iterations:**
  - Settings page uses `await searchParams` (Next.js 16 pattern — searchParams is a Promise in page components)
  - For "show toast on mount" in server-rendered pages: extract a `"use client"` child component that calls `useEffect` → `toast()` — cannot use useEffect in server components
  - Sidebar Settings link follows the exact same className pattern as virtualFolders links; wrapped in a border-top div for visual separation
  - Middleware covers /dashboard/settings automatically — no changes needed since only public routes are whitelisted
---

## 2026-02-18 - US-005
- Created `lib/services/x-bookmarks.ts` with `XBookmark` type and `fetchXBookmarks` function
- Fetches from GET https://api.twitter.com/2/users/{xUserId}/bookmarks with tweet.fields, expansions, user.fields
- Handles pagination via pagination_token loop, stopping when maxResults reached or no next_token
- Handles 429 rate limit responses by returning partial results with hasMore: true
- Constructs stable URLs as https://x.com/{authorHandle}/status/{tweetId}
- Matches author data from includes.users map keyed by author_id
- Respects MAX_SYNC_BOOKMARKS env var (default 50) for per-sync cap
- Returns { bookmarks, hasMore, nextToken }
- Files changed: `lib/services/x-bookmarks.ts`
- **Learnings for future iterations:**
  - X API v2 bookmark endpoint: `GET /2/users/{xUserId}/bookmarks` with Bearer token auth
  - Build a Map<author_id, XUser> from includes.users for O(1) author lookup per tweet
  - Break out of pagination loop when response has no data or no next_token; set hasMore=false
  - hasMore stays true if we hit maxResults mid-page (there may be more on the API side)
---

## 2026-02-18 - US-006
- Created `lib/actions/x-sync.ts` with `syncXBookmarks()` server action
- Fetches user's XIntegration record; returns error if not connected
- Refreshes token if expired via `refreshXToken()` from `lib/services/x-auth.ts`
- Calls `fetchXBookmarks` with accessToken, xUserId, and sinceId from lastSyncedTweetId
- Deduplicates by externalId — skips if a Bookmark with matching externalId+userId exists
- Creates new Bookmark records with url, title (first 100 chars truncated), description (full text), source: 'x', externalId
- Fires AI tag suggestions async (non-blocking) via private `autoTagBookmark` helper
- Updates XIntegration.lastSyncedAt and lastSyncedTweetId to most recent tweet ID
- Calls revalidatePath('/dashboard', 'layout')
- Returns { success, imported, skipped }
- Files changed: `lib/actions/x-sync.ts`
- **Learnings for future iterations:**
  - X API returns bookmarks newest first — first item in result.bookmarks is the most recent tweet ID
  - The `@@unique([externalId, userId])` constraint means we can use `findFirst` for dedup check; alternatively could try/catch a create with unique conflict
  - Auto-tag pattern: extract a private async helper, call it with `.catch(() => {})` to fire-and-forget without blocking the sync loop
  - The `autoTagBookmark` helper follows the same pattern as `fetchAndUpdateMetadata` in `lib/actions/bookmark.ts`
---

## 2026-02-18 - US-002
- Created `app/api/auth/x/route.ts` with GET handler for X OAuth initiation
- Generates PKCE code_verifier (96 random bytes → base64url = 128 chars) and S256 code_challenge
- Generates random state for CSRF protection
- Signs cookie payload with HMAC-SHA256 using NEXTAUTH_SECRET to prevent tampering
- Stores signed JSON (codeVerifier + state) in HTTP-only cookie `x_oauth_pkce` (10 min TTL)
- Redirects to https://twitter.com/i/oauth2/authorize with all required params
- Returns 401 if user not authenticated via auth(), 500 if env vars missing
- Files changed: `app/api/auth/x/route.ts`
- **Learnings for future iterations:**
  - Cookie signing: use HMAC-SHA256 with NEXTAUTH_SECRET; format is `${hmac}.${base64(payload)}`
  - PKCE base64url encoding: replace +→-, /→_, strip = padding; use crypto.randomBytes(96) for 128-char verifier
  - Next.js API routes use NextResponse.redirect() and can set cookies on the response before redirecting
---
