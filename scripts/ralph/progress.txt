## Codebase Patterns
- Use Prisma v6 (not v7) — v7 requires a `prisma.config.ts` and removed `url` from schema datasource
- PostgreSQL runs in Docker container `pomo-city-postgres-1` with user `pomo`, password `pomo` on port 5432
- Prisma client singleton is at `lib/prisma.ts` — import from `@/lib/prisma`
- Project uses bun as package manager, Next.js 16, shadcn/ui, Tailwind v4
- Path alias `@/*` maps to project root
- Prisma v6 used (not v7). DB connects to local PostgreSQL with user pomo/pomo. Prisma v6 warns about `package.json#prisma` config being deprecated in v7.
- Seed script uses `npx tsx prisma/seed.ts` — tsx is auto-installed by npx.
- NextAuth.js v5 (beta.30) with JWT strategy and credentials provider — no Prisma adapter (custom User model).
- Auth config lives in `lib/auth.ts`, exports `{ handlers, signIn, signOut, auth }`.
- Session helper functions in `lib/session.ts` — use `getCurrentUser()` or `requireUser()` for auth checks.
- Server actions go in `lib/actions/` directory.
- Type augmentations for next-auth in `types/next-auth.d.ts`.
- Path alias: `@/*` maps to project root.
- shadcn/ui with "new-york" style, stone base color, lucide icons.
- Tailwind CSS v4 with PostCSS plugin.
- Auth pages use `(auth)` route group with centered layout in `app/(auth)/layout.tsx`.
- `next lint` command doesn't work (Next.js 16 changed CLI); use `npx eslint` directly instead.
- Auth middleware at `middleware.ts` uses `auth()` from `lib/auth.ts` — public routes: `/`, `/login`, `/register`, `/share/*`.
- Services go in `lib/services/` directory — use `"use server"` directive for server-side-only code.
- Dashboard layout uses server component (`app/dashboard/layout.tsx`) to fetch data, passes to client `DashboardShell` component.
- Sidebar is a client component (`components/sidebar.tsx`) that reads `?folder=` query param for active state.
- Mobile sidebar uses shadcn/ui Sheet component (left side) with hamburger menu trigger.
- Folder tree built from flat Prisma query via `buildFolderTree()` helper in dashboard layout.
- Sonner (toast) installed as shadcn/ui component; Toaster added to root `app/layout.tsx`. Use `toast()` from `sonner` package.
- Bookmark server actions in `lib/actions/bookmark.ts` — use `requireUser()` for auth.
- Use `<img>` (not `next/image`) for external bookmark images — arbitrary domains can't be preconfigured.
- Pass dates as ISO strings from server to client components (Date objects can't cross the boundary).
- Prisma join table queries: `include: { tags: { include: { tag: true } } }`, then flatten with `.map(bt => bt.tag)`.
- For localStorage-backed state, use `useSyncExternalStore` (not useState + useEffect) to avoid ESLint `set-state-in-effect` error.
- Cursor-based pagination pattern: `take: limit + 1`, check `length > limit` for hasMore, `slice(0, limit)` for results.

# Ralph Progress Log
Started: Tue Feb 17 02:05:07 WIB 2026
---

## 2026-02-17 - US-001
- Implemented Prisma schema with all 6 models: User, Bookmark, Folder, Tag, BookmarkTag, BookmarkFolder
- All models include required fields per acceptance criteria (isFavorite, isPublic, shareId, visitCount, etc.)
- Self-referential Folder relation for nested folders (parentId)
- Unique constraints on User.email and Tag [name, userId]
- Created Prisma client singleton at lib/prisma.ts
- Migration ran successfully against PostgreSQL
- Files changed: package.json, bun.lock, prisma/schema.prisma, prisma/migrations/*, lib/prisma.ts
- **Learnings for future iterations:**
  - Prisma v7 removed `url` from datasource block — use v6 to avoid needing prisma.config.ts
  - Local PostgreSQL is in Docker (pomo-city-postgres-1), user=pomo, pass=pomo — needed to create markah DB manually
  - .env needs DATABASE_URL with pomo credentials, not default postgres/postgres
---

## 2026-02-17 - US-002
- What was implemented: NextAuth.js v5 credentials authentication setup
- Files changed:
  - `lib/auth.ts` — NextAuth config with credentials provider, JWT callbacks
  - `lib/session.ts` — getCurrentUser() and requireUser() helper functions
  - `lib/actions/auth.ts` — registerUser() server action with bcrypt hashing
  - `app/api/auth/[...nextauth]/route.ts` — API route handler
  - `types/next-auth.d.ts` — Session type augmentation to include user.id
  - `package.json` — Added next-auth, bcryptjs, @types/bcryptjs
  - `.env` — Added NEXTAUTH_SECRET
- **Learnings for future iterations:**
  - NextAuth v5 doesn't need Prisma adapter when using custom User model without Account/Session tables
  - Credentials provider uses JWT strategy (not database sessions)
  - The `authorize` callback in credentials provider must return `null` for invalid credentials (not throw)
  - Session callback chain: user → jwt callback (adds id to token) → session callback (adds id to session.user)
---

## 2026-02-17 - US-003
- What was implemented: Registration page UI at /register
- Files changed:
  - `app/(auth)/layout.tsx` — Shared auth layout with centered card design
  - `app/(auth)/register/page.tsx` — Registration form with email/password, validation, error handling
  - `components/ui/button.tsx` — shadcn/ui Button component
  - `components/ui/input.tsx` — shadcn/ui Input component
  - `components/ui/label.tsx` — shadcn/ui Label component
  - `components/ui/card.tsx` — shadcn/ui Card component
- **Learnings for future iterations:**
  - shadcn/ui components installed via `npx shadcn@latest add <component> --yes`
  - Auth pages use (auth) route group for shared centered layout
  - `next lint` doesn't work in Next.js 16; use `npx eslint` directly
  - Registration uses existing `registerUser` server action from `lib/actions/auth.ts`
---

## 2026-02-17 - US-004
- What was implemented: Login page UI at /login
- Files changed:
  - `app/(auth)/login/page.tsx` — Login form with email/password, NextAuth signIn, error handling
- **Learnings for future iterations:**
  - Use `signIn("credentials", { ..., redirect: false })` from `next-auth/react` for client-side login with error handling
  - `signIn` returns `{ error: string | undefined }` — check `result?.error` to show error messages
  - Login page reuses same (auth) layout and shadcn/ui Card pattern as registration
  - `autoComplete="current-password"` for login vs `autoComplete="new-password"` for registration
---

## 2026-02-17 - US-005
- What was implemented: Auth middleware and protected routes
- Files changed:
  - `middleware.ts` — NextAuth v5 auth() middleware with route protection logic
- **Learnings for future iterations:**
  - NextAuth v5 exports `auth` from config that can wrap middleware: `export default auth((req) => { ... })`
  - `req.auth` is the session object in the middleware callback — truthy when logged in
  - Matcher `["/((?!api|_next/static|_next/image|favicon.ico).*)"]` excludes API routes and static assets
  - Public routes: `/`, `/login`, `/register`, `/share/*`
  - Auth routes (`/login`, `/register`) redirect to `/dashboard` when already authenticated
---

## 2026-02-17 - US-006
- What was implemented: Landing page at / with hero section, features grid, and placeholder illustration area
- Files changed:
  - `app/page.tsx` — Complete rewrite: hero section with app name, description, Get Started CTA, Sign In link, placeholder illustration, 6 feature cards, footer
  - `app/layout.tsx` — Updated metadata title and description for Markah
- **Learnings for future iterations:**
  - Landing page uses lucide-react icons (Bookmark, FolderOpen, Search, Share2, Sparkles, Tag) — already available in project
  - stone color palette consistent with auth pages (bg-stone-50, text-stone-900, etc.)
  - FeatureCard is a local component in page.tsx — no need for separate file for single-use components
---

## 2026-02-17 - US-007
- What was implemented: Prisma seed script with test data
- Files changed:
  - `prisma/seed.ts` — Seed script creating test user, 12 bookmarks, 8 tags, 3 folders with associations
  - `package.json` — Added `prisma.seed` config pointing to `npx tsx prisma/seed.ts`
- **Learnings for future iterations:**
  - Seed idempotency: upsert for user, then delete-recreate for all child data (tags, folders, bookmarks, associations)
  - `prisma.seed` in package.json is deprecated in Prisma v7 — will need prisma.config.ts migration eventually
  - tsx is not a project dependency but npx auto-installs it; consider adding to devDependencies if seed runs in CI
  - Test user credentials: test@markah.com / password123
---

## 2026-02-17 - US-008
- What was implemented: Link preview fetching service at lib/services/link-preview.ts
- Files changed:
  - `lib/services/link-preview.ts` — Server-side service that fetches a URL and extracts OG/meta tag data (title, description, image, favicon)
- **Learnings for future iterations:**
  - No external HTML parser needed — regex works fine for extracting meta tags from HTML head
  - `"use server"` directive used to keep the service server-side only
  - AbortController with setTimeout provides clean 10s fetch timeout
  - Meta tags can have property/name and content in either order — regex must handle both
  - Relative URLs in og:image and favicon href need resolving against the base URL
  - Graceful fallback: hostname extracted from URL used as title when fetch fails entirely
---

## 2026-02-17 - US-009
- What was implemented: Dashboard layout with fixed sidebar and responsive mobile menu
- Files changed:
  - `app/dashboard/layout.tsx` — Server component: fetches user + folders, builds folder tree, passes to DashboardShell
  - `app/dashboard/page.tsx` — Placeholder dashboard page
  - `components/dashboard-shell.tsx` — Client component: sidebar (desktop), Sheet sidebar (mobile), header with user email + logout
  - `components/sidebar.tsx` — Client component: virtual folders (All, Favorites, Unsorted) + user folder tree with nesting
  - `components/ui/sheet.tsx` — shadcn/ui Sheet component (installed)
- **Learnings for future iterations:**
  - Dashboard uses server→client component split: layout.tsx (server) fetches data, DashboardShell (client) handles interactivity
  - Sidebar active state based on `?folder=` search param, not pathname
  - Folder tree built from flat DB query using parentId→children mapping
  - Sheet component from shadcn/ui uses Radix Dialog internally; must include SheetTitle for accessibility
  - signOut from next-auth/react with `{ redirectTo: "/" }` for post-logout redirect
---

## 2026-02-17 - US-010
- What was implemented: Quick-add bookmark URL bar at top of dashboard
- Files changed:
  - `lib/actions/bookmark.ts` — Server action: addBookmark creates bookmark, checks duplicates, async metadata fetch
  - `components/quick-add-bar.tsx` — Client component: URL input with loading state, URL validation/normalization, toast on duplicate
  - `components/ui/sonner.tsx` — Sonner toast component (shadcn/ui)
  - `app/layout.tsx` — Added Toaster to root layout
  - `app/dashboard/page.tsx` — Integrated QuickAddBar component
  - `prd.json` — Marked US-010 as passes: true
- **Learnings for future iterations:**
  - Sonner toast: import `toast` from `sonner` package, `Toaster` component from `components/ui/sonner.tsx`
  - Server actions can fire-and-forget async operations (metadata fetch) by calling `.catch()` without awaiting
  - URL normalization: prepend `https://` if no protocol, validate with `new URL()` constructor
  - `router.refresh()` from `next/navigation` triggers server component re-render to show updated data
---

## 2026-02-17 - US-011
- What was implemented: BookmarkCard component displaying thumbnail/color card, title, description snippet, domain, tags as colored badges, date saved, and star/favorite toggle
- Files changed:
  - `components/bookmark-card.tsx` — Client component: BookmarkCard with thumbnail/color card, tag badges, favorite toggle with optimistic UI
  - `components/ui/badge.tsx` — shadcn/ui Badge component (installed)
  - `lib/actions/bookmark.ts` — Added `toggleFavorite` server action
  - `app/dashboard/page.tsx` — Converted to server component, fetches bookmarks with tags, renders in responsive grid
- **Learnings for future iterations:**
  - Use `<img>` (not `next/image`) for external bookmark images/favicons — arbitrary domains can't be preconfigured in next.config
  - Deterministic color from string: `hashCode(str) % 360` for HSL hue — works well for both domain backgrounds and tag badge colors
  - BookmarkCardData type uses `string` for dates (ISO format) since Date objects can't be passed as props from server to client components
  - Prisma `include: { tags: { include: { tag: true } } }` fetches through join table — map `b.tags.map(bt => bt.tag)` to flatten
  - Optimistic UI for favorite toggle: update local state immediately, revert on error, call `router.refresh()` after server action
---

## 2026-02-17 - US-012
- What was implemented: Bookmark list view with grid/list toggle, cursor-based pagination
- Files changed:
  - `components/bookmark-list-view.tsx` — Client component: grid/list toggle with localStorage persistence via useSyncExternalStore, cursor-based "Load more" pagination
  - `components/bookmark-list-item.tsx` — Compact list row component: favicon, title, domain, tags (max 3), date, favorite toggle
  - `lib/actions/bookmark.ts` — Added `getBookmarks` server action with cursor-based pagination (20 per page)
  - `app/dashboard/page.tsx` — Refactored to use BookmarkListView with initial data from getBookmarks
  - `scripts/ralph/prd.json` — Marked US-012 as passes: true
- **Learnings for future iterations:**
  - ESLint `react-hooks/set-state-in-effect` rule disallows `setState` inside `useEffect` — use `useSyncExternalStore` for localStorage-backed state instead
  - `useSyncExternalStore(subscribe, getSnapshot, getServerSnapshot)` is the correct way to read from external stores (like localStorage) without hydration mismatch
  - Cursor-based pagination: `take: limit + 1` to check if there are more, then `slice(0, limit)` for the actual results
  - `useTransition` works well for "Load more" — wraps the server action call and provides `loading` state automatically
---

## 2026-02-17 - US-013
- What was implemented: Visit tracking on bookmark click
- Files changed:
  - `lib/actions/bookmark.ts` — Added `recordVisit` server action (increments visitCount, sets lastVisitedAt); added visitCount/lastVisitedAt to getBookmarks response mapping
  - `components/bookmark-card.tsx` — Added visitCount/lastVisitedAt to BookmarkCardData type; onClick handler fires recordVisit; displays visit count and relative lastVisitedAt time
  - `components/bookmark-list-item.tsx` — Added onClick handler for recordVisit; displays visit count and relative lastVisitedAt in list view
  - `scripts/ralph/prd.json` — Marked US-013 as passes: true
- **Learnings for future iterations:**
  - `prisma.updateMany` is useful for conditional updates (where + userId check) without needing to fetch first — unlike `update` which only takes `id` in where
  - Fire-and-forget pattern for visit tracking: `recordVisit(id).catch(() => {})` — don't await, don't block navigation
  - `formatRelativeTime` helper duplicated in bookmark-card and bookmark-list-item — consider extracting to shared utils if used again
---
